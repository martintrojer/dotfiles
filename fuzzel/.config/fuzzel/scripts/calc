#!/usr/bin/env python3
"""Calculator using qalc (preferred) or bc."""

from __future__ import annotations

import argparse

from _common import ScriptError, command_exists, fuzzel_dmenu, notify, require_commands, run


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--prompt", default="Calc  ")
    parser.add_argument("--width", type=int, default=40)
    return parser.parse_args()


def evaluate(query: str) -> str:
    if command_exists("qalc"):
        result = run(["qalc", "-t", query], check=False)
        return result.stdout.strip()

    if command_exists("bc"):
        result = run(["bc", "-l"], input_text=f"{query}\n", check=False)
        return result.stdout.strip()

    raise ScriptError("Neither qalc nor bc is installed")


def main() -> int:
    args = parse_args()
    require_commands(["fuzzel"])

    answer = ""
    while True:
        query = fuzzel_dmenu(prompt=args.prompt, width=args.width, input_text=answer)
        if not query:
            break

        answer = evaluate(query)
        if not answer:
            notify("Calculator", f"Could not evaluate: {query}")
            continue

        if command_exists("wl-copy"):
            run(["wl-copy"], input_text=answer, check=False)
            notify("Calculator", f"{query} = {answer} (copied)")
        else:
            notify("Calculator", f"{query} = {answer}")

    return 0


if __name__ == "__main__":
    try:
        raise SystemExit(main())
    except ScriptError as exc:
        print(f"calc: {exc}")
        raise SystemExit(1)
