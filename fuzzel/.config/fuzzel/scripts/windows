#!/usr/bin/env python3
"""Window switcher using niri msg."""

from __future__ import annotations

import argparse
import json

from _common import ScriptError, fuzzel_dmenu, notify, picker_cache_path, require_commands, run


def parse_args() -> argparse.Namespace:
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--prompt", default="Windows  ")
    parser.add_argument("--width", type=int, default=60)
    parser.add_argument("--lines", type=int, default=15)
    return parser.parse_args()


def list_windows() -> list[dict]:
    result = run(["niri", "msg", "-j", "windows"], check=False)
    if result.returncode != 0:
        return []
    windows = json.loads(result.stdout)
    if not isinstance(windows, list):
        return []
    return windows


def main() -> int:
    args = parse_args()
    require_commands(["niri", "fuzzel"])
    cache = picker_cache_path("windows")

    windows = list_windows()
    if not windows:
        notify("Windows", "No windows open or niri is unavailable")
        return 0

    display_options: list[str] = []
    for item in windows:
        app_id = item.get("app_id") or "unknown"
        title = item.get("title") or "untitled"
        display_options.append(f"{app_id}: {title}")

    selected = fuzzel_dmenu(
        prompt=args.prompt,
        width=args.width,
        lines=args.lines,
        cache=cache,
        options=display_options,
    )
    if not selected:
        return 0

    try:
        idx = display_options.index(selected)
    except ValueError:
        return 0

    window_id = windows[idx].get("id")
    if window_id is None:
        return 0

    run(["niri", "msg", "action", "focus-window", "--id", str(window_id)], check=False)
    return 0


if __name__ == "__main__":
    try:
        raise SystemExit(main())
    except (ScriptError, json.JSONDecodeError) as exc:
        print(f"windows: {exc}")
        raise SystemExit(1)
